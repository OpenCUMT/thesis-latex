name: Build CUMT LaTeX Thesis

on: 
  push:
    branches: [main, dev-*]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  # 模块化包管理
  CORE_PKGS: "scheme-full latexmk l3build"
  CJK_PKGS: "ctex xecjk zhnumber cjk cjkpunct fandol"
  FONT_PKGS: "tex-gyre xits noto-cjk noto-cjk-extra"
  BIB_PKGS: "biblatex biber biblatex-gb7714-2015"
  UTIL_PKGS: "algorithm2e mhchem upgreek makecell multirow subcaption colortbl tabularx tocloft titletoc footmisc fancyhdr microtype etoolbox enumitem lastpage ulem geometry emptypage indentfirst listings"
  
  # 编译配置
  COMPILER: "xelatex"
  BIBER: "biber"
  MAIN_FILE: "thesis.tex"

jobs:
  setup:
    name: Setup TeX Live
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.head_commit.message, 'ci skip') }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install TeX Live with required packages
        uses: TeX-Live/setup-texlive-action@v3
        with:
          packages: ${{ env.CORE_PKGS }} ${{ env.CJK_PKGS }} ${{ env.FONT_PKGS }} ${{ env.BIB_PKGS }} ${{ env.UTIL_PKGS }}
          update-all-packages: true
      
      - name: Install system fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            fonts-wqy-microhei fonts-wqy-zenhei \
            fonts-arphic-ukai fonts-arphic-uming \
            fonts-noto-cjk fonts-noto-cjk-extra
          
          # 安装项目自定义字体
          if [ -d "Assets/Fonts" ]; then
            sudo mkdir -p /usr/share/fonts/truetype/cumt-thesis
            sudo cp Assets/Fonts/*.ttf /usr/share/fonts/truetype/cumt-thesis/ || echo "字体安装完成（部分文件可能缺失）"
            fc-cache -fv
          fi
          
          echo "=== 可用中文字体 ==="
          fc-list :lang=zh-cn | head -10

  build:
    name: Build Thesis
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: src
          
      - name: Validate project structure
        working-directory: ./src
        run: |
          echo "验证项目结构..."
          required_files=("thesis.tex" "cumtthesis.cls" "bibliography.bib")
          required_dirs=("Chapters" "Figures")
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "::error::缺失必要文件: $file"
              exit 1
            fi
          done
          
          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "::warning::缺失目录: $dir (但继续编译)"
            fi
          done
          
          echo "项目结构验证通过"

      - name: Compile with latexmk
        working-directory: ./src
        run: |
          # 创建latexmk配置文件
          cat > latexmkrc << 'EOF'
          $pdf_mode = 1;
          $bibtex_use = 2;
          $postscript_mode = $dvi_mode = 0;
          $pdflatex = "xelatex -interaction=nonstopmode -halt-on-error %O %S";
          EOF
          
          latexmk -pdfxe -outdir=../build $MAIN_FILE
          
          # 检查输出文件
          if [ ! -f "../build/thesis.pdf" ]; then
            echo "::error::PDF生成失败"
            echo "=== 编译日志 ==="
            cat ../build/*.log
            exit 1
          fi
          
          echo "编译成功！PDF大小: $(du -h ../build/thesis.pdf | cut -f1)"

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: thesis-pdf
          path: build/thesis.pdf
          retention-days: 30

      - name: Archive build logs
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build/*.log
          retention-days: 7

  test:
    name: Cross-Platform Test
    needs: setup
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        tex-distro: ["tl", "mactex"] # TeX Live 和 MacTeX
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install TeX Live
        if: ${{ matrix.tex-distro == 'tl' }}
        uses: TeX-Live/setup-texlive-action@v3
        with:
          packages: ${{ env.CORE_PKGS }} ${{ env.CJK_PKGS }} ${{ env.BIB_PKGS }}
          update-all-packages: true
          
      - name: Install MacTeX
        if: ${{ matrix.os == 'macos-latest' && matrix.tex-distro == 'mactex' }}
        run: |
          brew install mactex-no-gui
          eval "$(/usr/libexec/path_helper)"
          
      - name: Minimal compile test
        run: |
          # 创建最小测试文档
          cat > test.tex << 'EOF'
          \documentclass{article}
          \usepackage{ctex}
          \begin{document}
          \title{跨平台测试}
          \author{中国矿业大学}
          \maketitle
          \section{测试}
          这是一个编译测试。\LaTeX
          \end{document}
          EOF
          
          xelatex -interaction=nonstopmode test.tex
          
          if [ ! -f "test.pdf" ]; then
            echo "::error::在 ${{ matrix.os }}/${{ matrix.tex-distro }} 上编译失败"
            exit 1
          fi

  release:
    name: Create Release
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Determine version
        id: version
        run: |
          if git describe --tags --exact-match HEAD 2>/dev/null; then
            version=$(git describe --tags --exact-match HEAD)
          else
            commit_short=$(git rev-parse --short HEAD)
            version="v0.0.0-$commit_short"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          
      - name: Create release package
        run: |
          # 创建包含源码和PDF的发布包
          mkdir -p cumt-thesis-${{ steps.version.outputs.version }}
          
          # 复制源码（排除无关文件）
          rsync -av \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.vscode' \
            --exclude='*.log' \
            --exclude='*.aux' \
            --exclude='*.pdf' \
            --exclude='build/' \
            ./ cumt-thesis-${{ steps.version.outputs.version }}/
          
          # 添加编译好的PDF
          cp build/thesis.pdf cumt-thesis-${{ steps.version.outputs.version }}/cumt-thesis-${{ steps.version.outputs.version }}.pdf
          
          # 创建ZIP包
          zip -r cumt-thesis-${{ steps.version.outputs.version }}.zip cumt-thesis-${{ steps.version.outputs.version }}
          
      - name: Upload release assets
        uses: actions/upload-artifact@v4
        with:
          name: release-package
          path: |
            cumt-thesis-${{ steps.version.outputs.version }}.zip
          retention-days: 90
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: cumt-thesis-${{ steps.version.outputs.version }}.zip
          generate_release_notes: true