name: Build LaTeX Thesis

on: 
  push:
    branches: [ main, dev-* ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  # ä¸­æ–‡æ”¯æŒåŒ…
  XECJK_PKGS: fontspec xecjk ulem xetex
  CTEX_PKGS: cjk ctex everysel zhnumber
  # å‚è€ƒæ–‡çŒ®æ”¯æŒ (å›½æ ‡GB7714-2015)
  BIBLATEX_PKGS: biber biblatex biblatex-gb7714-2015
  # é¡µé¢å¸ƒå±€å’Œè¶…é“¾æ¥
  HYPERREF_PKGS: pdflscape hyperref
  # åŸºç¡€åŒ…
  REQUIRED_PKGS: >-
    scheme-basic bibunits bigfoot caption enumitem
    environ etoolbox filehook footmisc notoccite pdfpages threeparttable
    titlesec trimspaces unicode-math geometry fancyhdr
  # ä¸­æ–‡å­—ä½“
  FONT_PKGS: fandol tex-gyre xits
  # æ•°å­¦å’Œè¡¨æ ¼æ‰©å±•åŒ…  
  EXTRA_PKGS: algorithms booktabs ntheorem siunitx float fp multirow amsmath amsfonts
  # ä»£ç å’Œé¢œè‰²æ”¯æŒ
  DOC_PKGS: listings xcolor
  # æ„å»ºå·¥å…·
  BIN_PKGS: latexmk

jobs:
  build:
    name: Build Thesis PDF
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup TeX Live
        uses: TeX-Live/setup-texlive-action@v3
        with:
          packages: >-
            ${{ env.XECJK_PKGS }} ${{ env.CTEX_PKGS }} ${{ env.BIBLATEX_PKGS }}
            ${{ env.HYPERREF_PKGS }} ${{ env.REQUIRED_PKGS }} ${{ env.FONT_PKGS }}
            ${{ env.EXTRA_PKGS }} ${{ env.DOC_PKGS }} ${{ env.BIN_PKGS }}
            xstring
          update-all-packages: true
          cache: true
      
      - name: Compile thesis (first pass)
        run: |
          echo "å¼€å§‹ç¼–è¯‘ä¸­å›½çŸ¿ä¸šå¤§å­¦å­¦ä½è®ºæ–‡..."
          latexmk -xelatex -interaction=nonstopmode thesis.tex
      
      - name: Check if PDF was generated
        run: |
          if [ -f thesis.pdf ]; then
            echo "âœ… PDF ç”ŸæˆæˆåŠŸ"
            ls -lh thesis.pdf
          else
            echo "âŒ PDF ç”Ÿæˆå¤±è´¥"
            exit 1
          fi
      
      - name: Upload thesis PDF
        uses: actions/upload-artifact@v4
        with:
          name: cumt-thesis-pdf
          path: thesis.pdf
          retention-days: 30
      
      - name: Create release package
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # è·å–ç‰ˆæœ¬ä¿¡æ¯
          if git describe --tags --exact-match HEAD 2>/dev/null; then
            version=$(git describe --tags --exact-match HEAD)
          else
            version="main-$(git rev-parse --short HEAD)"
          fi
          
          echo "åˆ›å»ºå‘å¸ƒåŒ…: cumt-thesis-$version.zip"
          
          # åˆ›å»ºå‘å¸ƒåŒ…ï¼Œæ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶
          zip -r "cumt-thesis-$version.zip" . \
            -x "*.git*" "*.github*" "*.vscode*" "*.DS_Store" \
            -x "*.log" "*.aux" "*.out" "*.toc" "*.lof" "*.lot" \
            -x "*.fls" "*.fdb_latexmk" "*.bbl" "*.blg" "*.run.xml" \
            -x "*.bcf" "*.synctex.gz" "*.nav" "*.snm" "*.vrb"
      
      - name: Upload release package
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: cumt-thesis-release
          path: cumt-thesis-*.zip
          retention-days: 90

  test-compatibility:
    name: Cross-platform Compatibility Test
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-14]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup TeX Live
        uses: TeX-Live/setup-texlive-action@v3
        with:
          packages: >-
            ${{ env.XECJK_PKGS }} ${{ env.CTEX_PKGS }} ${{ env.BIBLATEX_PKGS }}
            ${{ env.HYPERREF_PKGS }} ${{ env.REQUIRED_PKGS }} ${{ env.FONT_PKGS }}
            ${{ env.EXTRA_PKGS }} ${{ env.DOC_PKGS }} ${{ env.BIN_PKGS }}
            xstring
          update-all-packages: true
          cache: true
      
      - name: Test compilation
        run: |
          echo "åœ¨ ${{ matrix.os }} ä¸Šæµ‹è¯•ç¼–è¯‘..."
          timeout 600 latexmk -xelatex -interaction=nonstopmode thesis.tex || {
            echo "ç¼–è¯‘è¶…æ—¶æˆ–å¤±è´¥ï¼Œæ£€æŸ¥æ—¥å¿—..."
            if [ -f thesis.log ]; then
              echo "=== LaTeX é”™è¯¯æ—¥å¿— ==="
              grep -A 5 -B 5 "Error\|Fatal\|Emergency" thesis.log || echo "æœªå‘ç°æ˜æ˜¾é”™è¯¯"
            fi
            exit 1
          }
      
      - name: Verify output
        run: |
          if [ -f thesis.pdf ]; then
            echo "âœ… ${{ matrix.os }} ç¼–è¯‘æˆåŠŸ"
            file thesis.pdf
            ls -lh thesis.pdf
          else
            echo "âŒ ${{ matrix.os }} ç¼–è¯‘å¤±è´¥ - PDF æœªç”Ÿæˆ"
            exit 1
          fi
      
      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-fail-${{ matrix.os }}-${{ github.run_number }}
          path: |
            thesis.log
            thesis.aux
            thesis.blg
            thesis.bbl
            *.fls
            *.fdb_latexmk
          retention-days: 7

  # æ¨¡æ¿éªŒè¯ä»»åŠ¡
  validate-template:
    name: Validate Template Structure  
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Validate file structure
        run: |
          echo "éªŒè¯æ¨¡æ¿æ–‡ä»¶ç»“æ„..."
          
          # æ£€æŸ¥å¿…éœ€æ–‡ä»¶
          required_files=(
            "thesis.tex"
            "cumtthesis.cls" 
            "bibliography.bib"
            ".latexmkrc"
          )
          
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file å­˜åœ¨"
            else
              echo "âŒ ç¼ºå°‘å¿…éœ€æ–‡ä»¶: $file"
              exit 1
            fi
          done
          
          # æ£€æŸ¥å¿…éœ€ç›®å½•
          required_dirs=(
            "Chapters"
            "Figures" 
            "Assets/Fonts"
            "Assets/Logos"
          )
          
          for dir in "${required_dirs[@]}"; do
            if [ -d "$dir" ]; then
              echo "âœ… $dir/ ç›®å½•å­˜åœ¨"
            else
              echo "âŒ ç¼ºå°‘å¿…éœ€ç›®å½•: $dir/"
              exit 1
            fi
          done
          
          echo "æ¨¡æ¿ç»“æ„éªŒè¯å®Œæˆ"
      
      - name: Check class file version
        run: |
          if grep -q "v2\.3\.7" cumtthesis.cls; then
            echo "âœ… æ¨¡æ¿ç‰ˆæœ¬: $(grep -o 'v[0-9]\+\.[0-9]\+\.[0-9]\+' cumtthesis.cls)"
          else
            echo "âš ï¸  è¯·æ£€æŸ¥æ¨¡æ¿ç‰ˆæœ¬ä¿¡æ¯"
          fi

  # è‡ªåŠ¨å‘å¸ƒ
  release:
    name: Create Release
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    needs: [build, test-compatibility, validate-template]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: cumt-thesis-pdf
          
      - name: Download release package  
        uses: actions/download-artifact@v4
        with:
          name: cumt-thesis-release
      
      - name: Extract version
        id: version
        run: |
          version=${GITHUB_REF#refs/tags/}
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "å‘å¸ƒç‰ˆæœ¬: $version"
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: CUMT Thesis Template ${{ steps.version.outputs.version }}
          body: |
            ## ä¸­å›½çŸ¿ä¸šå¤§å­¦å­¦ä½è®ºæ–‡ LaTeX æ¨¡æ¿ ${{ steps.version.outputs.version }}
            
            ### ğŸ“¦ ä¸‹è½½è¯´æ˜
            - `thesis.pdf` - ç¼–è¯‘å¥½çš„ç¤ºä¾‹è®ºæ–‡
            - `cumt-thesis-${{ steps.version.outputs.version }}.zip` - å®Œæ•´æ¨¡æ¿åŒ…
            
            ### ğŸ›  ä½¿ç”¨æ–¹æ³•
            1. ä¸‹è½½å¹¶è§£å‹æ¨¡æ¿åŒ…
            2. ç¼–è¾‘ `thesis.tex` é…ç½®è®ºæ–‡ä¿¡æ¯
            3. åœ¨ `Chapters/` ç›®å½•ä¸‹ç¼–å†™å„ç« èŠ‚å†…å®¹
            4. è¿è¡Œ `latexmk -xelatex thesis.tex` ç¼–è¯‘
            
            ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
            - XeLaTeX å¼•æ“
            - TeX Live 2023 æˆ–æ›´æ–°ç‰ˆæœ¬
            - æ”¯æŒä¸­æ–‡çš„æ“ä½œç³»ç»Ÿ
            
            è¯¦ç»†è¯´æ˜è¯·å‚è€ƒæ¨¡æ¿å†…çš„ README.md æ–‡ä»¶ã€‚
          files: |
            thesis.pdf
            cumt-thesis-*.zip
          draft: false
          prerelease: false