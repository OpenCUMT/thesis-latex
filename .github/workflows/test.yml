name: Build LaTeX Thesis

on: 
  push:
    branches: [ main, dev-* ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  # 使用完整 TeX Live 方案确保所有依赖包可用
  TEXLIVE_INSTALL: scheme-full

jobs:
  build:
    name: Build Thesis PDF
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup TeX Live
        uses: TeX-Live/setup-texlive-action@v3
        with:
          update-all-packages: true
          cache: true
      
      - name: Compile thesis (first pass)
        run: |
          echo "开始编译中国矿业大学学位论文..."
          latexmk -xelatex -interaction=nonstopmode thesis.tex
      
      - name: Check if PDF was generated
        run: |
          if [ -f thesis.pdf ]; then
            echo "✅ PDF 生成成功"
            ls -lh thesis.pdf
          else
            echo "❌ PDF 生成失败"
            exit 1
          fi
      
      - name: Upload thesis PDF
        uses: actions/upload-artifact@v4
        with:
          name: cumt-thesis-pdf
          path: thesis.pdf
          retention-days: 30
      
      - name: Create release package
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # 获取版本信息
          if git describe --tags --exact-match HEAD 2>/dev/null; then
            version=$(git describe --tags --exact-match HEAD)
          else
            version="main-$(git rev-parse --short HEAD)"
          fi
          
          echo "创建发布包: cumt-thesis-$version.zip"
          
          # 创建发布包，排除不必要的文件
          zip -r "cumt-thesis-$version.zip" . \
            -x "*.git*" "*.github*" "*.vscode*" "*.DS_Store" \
            -x "*.log" "*.aux" "*.out" "*.toc" "*.lof" "*.lot" \
            -x "*.fls" "*.fdb_latexmk" "*.bbl" "*.blg" "*.run.xml" \
            -x "*.bcf" "*.synctex.gz" "*.nav" "*.snm" "*.vrb"
      
      - name: Upload release package
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: cumt-thesis-release
          path: cumt-thesis-*.zip
          retention-days: 90

  test-compatibility:
    name: Cross-platform Compatibility Test
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-14]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup TeX Live
        uses: TeX-Live/setup-texlive-action@v3
        with:
          update-all-packages: true
          cache: true
      
      - name: Test compilation
        run: |
          echo "在 ${{ matrix.os }} 上测试编译..."
          timeout 600 latexmk -xelatex -interaction=nonstopmode thesis.tex || {
            echo "编译超时或失败，检查日志..."
            if [ -f thesis.log ]; then
              echo "=== LaTeX 错误日志 ==="
              grep -A 5 -B 5 "Error\|Fatal\|Emergency" thesis.log || echo "未发现明显错误"
            fi
            exit 1
          }
      
      - name: Verify output
        run: |
          if [ -f thesis.pdf ]; then
            echo "✅ ${{ matrix.os }} 编译成功"
            file thesis.pdf
            ls -lh thesis.pdf
          else
            echo "❌ ${{ matrix.os }} 编译失败 - PDF 未生成"
            exit 1
          fi
      
      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-fail-${{ matrix.os }}-${{ github.run_number }}
          path: |
            thesis.log
            thesis.aux
            thesis.blg
            thesis.bbl
            *.fls
            *.fdb_latexmk
          retention-days: 7

  # 模板验证任务
  validate-template:
    name: Validate Template Structure  
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Validate file structure
        run: |
          echo "验证模板文件结构..."
          
          # 检查必需文件
          required_files=(
            "thesis.tex"
            "cumtthesis.cls" 
            "bibliography.bib"
            ".latexmkrc"
          )
          
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "✅ $file 存在"
            else
              echo "❌ 缺少必需文件: $file"
              exit 1
            fi
          done
          
          # 检查必需目录
          required_dirs=(
            "Chapters"
            "Figures" 
            "Assets/Fonts"
            "Assets/Logos"
          )
          
          for dir in "${required_dirs[@]}"; do
            if [ -d "$dir" ]; then
              echo "✅ $dir/ 目录存在"
            else
              echo "❌ 缺少必需目录: $dir/"
              exit 1
            fi
          done
          
          echo "模板结构验证完成"
      
      - name: Check class file version
        run: |
          if grep -q "v2\.3\.7" cumtthesis.cls; then
            echo "✅ 模板版本: $(grep -o 'v[0-9]\+\.[0-9]\+\.[0-9]\+' cumtthesis.cls)"
          else
            echo "⚠️  请检查模板版本信息"
          fi
